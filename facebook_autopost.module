<?php

/**
 * @file
 * Facebook Autopost module file.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_entity_insert().
 */
function facebook_autopost_entity_insert(EntityInterface $entity) {
  facebook_autopost_process_node($entity, 'insert');
}

/**
 * Implements hook_entity_update().
 */
function facebook_autopost_entity_update(EntityInterface $entity) {
  facebook_autopost_process_node($entity, 'update');
}

/**
 * Process a node for Facebook posting.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The entity to process.
 * @param string $operation
 *   The operation (insert or update).
 */
function facebook_autopost_process_node(EntityInterface $entity, $operation = 'insert') {
  $logger = \Drupal::logger('facebook_autopost');
  $config = \Drupal::config('facebook_autopost.settings');
  $detailed_logging = $config->get('detailed_logging') ?? TRUE;

  // Only process article nodes.
  if (!($entity instanceof NodeInterface) || $entity->bundle() !== 'article') {
    return;
  }

  if ($detailed_logging) {
    $logger->info('Processing @operation for article node @nid: @title', [
      '@operation' => $operation,
      '@nid' => $entity->id(),
      '@title' => $entity->getTitle(),
    ]);
  }

  // Check if already posted to avoid duplicate posts.
  if ($entity->hasField('field_facebook_posted') && !$entity->get('field_facebook_posted')->isEmpty() && $entity->get('field_facebook_posted')->value) {
    if ($detailed_logging) {
      $logger->info('Node @nid already posted to Facebook (field_facebook_posted is checked). Skipping.', [
        '@nid' => $entity->id(),
      ]);
    }
    return;
  }

  if ($detailed_logging) {
    $logger->info('Node @nid not marked as posted. Proceeding with Facebook posting checks.', [
      '@nid' => $entity->id(),
    ]);
  }

  // Check domain restrictions.
  $enabled_domains = $config->get('enabled_domains') ?? [];

  // If specific domains are configured, check if this node belongs to them.
  if (!empty($enabled_domains)) {
    if ($detailed_logging) {
      $logger->info('Domain filtering enabled. Checking node @nid against enabled domains: @domains', [
        '@nid' => $entity->id(),
        '@domains' => implode(', ', $enabled_domains),
      ]);
    }

    $node_domains = [];

    // Check if the node has domain access field.
    if (\Drupal::moduleHandler()->moduleExists('domain_access') && $entity->hasField('field_domain_access')) {
      // Get all domains assigned to this node.
      $domain_access = $entity->get('field_domain_access')->getValue();
      foreach ($domain_access as $domain_value) {
        if (isset($domain_value['target_id'])) {
          $node_domains[] = $domain_value['target_id'];
        }
      }
      if ($detailed_logging) {
        $logger->info('Node @nid has domain_access domains: @node_domains', [
          '@nid' => $entity->id(),
          '@node_domains' => implode(', ', $node_domains),
        ]);
      }
    }
    elseif (\Drupal::moduleHandler()->moduleExists('domain_source') && $entity->hasField('field_domain_source')) {
      // Use domain source if available.
      $domain_source = $entity->get('field_domain_source')->target_id;
      if ($domain_source) {
        $node_domains[] = $domain_source;
        if ($detailed_logging) {
          $logger->info('Node @nid has domain_source: @domain_source', [
            '@nid' => $entity->id(),
            '@domain_source' => $domain_source,
          ]);
        }
      }
    }

    // If no matching domains found, don't post.
    $should_post = FALSE;
    foreach ($node_domains as $node_domain) {
      if (in_array($node_domain, $enabled_domains)) {
        $should_post = TRUE;
        break;
      }
    }

    if (!$should_post) {
      if ($detailed_logging) {
        $logger->info('Skipping Facebook post for node @nid - not assigned to enabled domains. Node domains: @node_domains, Enabled domains: @enabled_domains', [
          '@nid' => $entity->id(),
          '@node_domains' => implode(', ', $node_domains),
          '@enabled_domains' => implode(', ', $enabled_domains),
        ]);
      }
      return;
    }

    if ($detailed_logging) {
      $logger->info('Node @nid matches enabled domains. Proceeding with posting.', [
        '@nid' => $entity->id(),
      ]);
    }
  }
  else {
    if ($detailed_logging) {
      $logger->info('No domain filtering configured. Posting to all domains.', []);
    }
  }

  // Post to Facebook.
  if ($detailed_logging) {
    $logger->info('Initiating Facebook posting for node @nid', [
      '@nid' => $entity->id(),
    ]);
  }

  $facebook_api = \Drupal::service('facebook_autopost.api');
  $results = $facebook_api->postNode($entity);

  // Mark as posted if at least one post was successful.
  $success = FALSE;
  $success_count = 0;
  $failure_count = 0;

  foreach ($results as $result) {
    if ($result['success']) {
      $success = TRUE;
      $success_count++;
    }
    else {
      $failure_count++;
    }
  }

  if ($detailed_logging) {
    $logger->info('Facebook posting completed for node @nid. Successes: @success_count, Failures: @failure_count', [
      '@nid' => $entity->id(),
      '@success_count' => $success_count,
      '@failure_count' => $failure_count,
    ]);
  }

  if ($success && $entity->hasField('field_facebook_posted')) {
    $entity->set('field_facebook_posted', TRUE);
    $entity->save();
    if ($detailed_logging) {
      $logger->info('Node @nid marked as posted to Facebook (field_facebook_posted set to TRUE).', [
        '@nid' => $entity->id(),
      ]);
    }
  }
}

/**
 * Implements hook_node_links_alter().
 */
function facebook_autopost_node_links_alter(array &$links, NodeInterface $entity, array &$context) {
  // Add a visual indicator that the node has been posted to Facebook.
  if ($entity->bundle() === 'article' && $entity->hasField('field_facebook_posted')) {
    $posted = $entity->get('field_facebook_posted')->value;
    if ($posted) {
      $links['facebook_posted'] = [
        '#theme' => 'link',
        '#title' => t('Posted to Facebook'),
        '#url' => \Drupal\Core\Url::fromRoute('<none>'),
        '#attributes' => [
          'class' => ['facebook-posted-indicator'],
          'style' => 'color: green; pointer-events: none;',
        ],
      ];
    }
  }
}
